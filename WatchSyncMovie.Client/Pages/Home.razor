@page "/"
@using WatchSyncMovie.Client.Models
@inject HttpClient HttpClient
@inject NavigationManager Navigation

<PageTitle>WatchSync - Watch Movies Together</PageTitle>

<div class="home-container">
    <div class="hero-section">
        <div class="hero-content">
            <h1><i class="fas fa-film"></i> WatchSync</h1>
            <p class="lead">Watch movies and series together with your friends in perfect synchronization</p>
            
            <div class="action-buttons">
                <button class="btn btn-primary btn-lg" @onclick="CreateNewRoom">
                    <i class="fas fa-plus"></i> Create Room
                </button>
                <div class="join-room-form">
                    <input @bind="roomIdToJoin" @onkeypress="HandleJoinKeyPress" class="form-control form-control-lg" placeholder="Enter Room ID" />
                    <button class="btn btn-outline-primary btn-lg" @onclick="JoinExistingRoom">
                        <i class="fas fa-sign-in-alt"></i> Join Room
                    </button>
                </div>
            </div>
        </div>
    </div>

    

    @if (activeRooms.Any())
    {
        <div class="active-rooms-section">
            <div class="container">
                <h2>Active Rooms</h2>
                <div class="rooms-grid">
                    @foreach (var room in activeRooms.Take(6))
                    {
                        <div class="room-card" @onclick="(() => JoinRoom(room.Id))">
                            <div class="room-header">
                                <h5>@room.Name</h5>
                                @if (room.HasPassword)
                                {
                                    <i class="fas fa-lock"></i>
                                }
                            </div>
                            <div class="room-info">
                                <span><i class="fas fa-users"></i> @room.UserCount users</span>
                                @if (room.IsPlaying)
                                {
                                    <span class="playing-indicator">
                                        <i class="fas fa-play"></i> Playing
                                    </span>
                                }
                            </div>
                            <small>Created @room.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string roomIdToJoin = "";
    private List<ActiveRoom> activeRooms = new();

    public class ActiveRoom
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public bool HasPassword { get; set; }
        public int UserCount { get; set; }
        public DateTime CreatedAt { get; set; }
        public string? CurrentMovie { get; set; }
        public bool IsPlaying { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadActiveRooms();
    }

    private async Task LoadActiveRooms()
    {
        try
        {
            activeRooms = await HttpClient.GetFromJsonAsync<List<ActiveRoom>>("api/rooms") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load active rooms: {ex.Message}");
        }
    }

    private void CreateNewRoom()
    {
        Navigation.NavigateTo("/room");
    }

    private void JoinExistingRoom()
    {
        if (!string.IsNullOrWhiteSpace(roomIdToJoin))
        {
            Navigation.NavigateTo($"/room/{roomIdToJoin}");
        }
    }

    private void JoinRoom(string roomId)
    {
        Navigation.NavigateTo($"/room/{roomId}");
    }

    private Task HandleJoinKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            JoinExistingRoom();
        }
        return Task.CompletedTask;
    }
}
